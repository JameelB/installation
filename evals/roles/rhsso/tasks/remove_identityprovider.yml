---
-
  name: Check master-config has been modified by the installer
  shell: "cat {{ rhsso_openshift_master_config_path }} | grep 'GENERATED BY SSO INSTALLER' | wc -l"
  become: yes
  register: output

-
  name: "rewrite master config and restart API"
  when: output.stdout != "0"
  block:
    -
      name: Remove RH-SSO identity provider from master config
      shell: "sed -i.bak '/# BEGIN GENERATED BY SSO INSTALLER/,/# END GENERATED BY SSO INSTALLER/d' {{ rhsso_openshift_master_config_path }}"
      args:
        warn: no
      become: yes

    -
      name: Read master-config to check
      command: cat "{{ rhsso_openshift_master_config_path }}"
      become: yes
      register: master_config_raw

    ## Use the master-config.yaml.bak file to get original content of identity provider 
    ## sed -n '/identityProvider/,/masterCA/{//!p}' {{ rhsso_openshift_master_config_path }}
    -
      name: Copy original content
      shell: "sed -n '/identityProvider/,/masterCA/{//!p}' {{ rhsso_openshift_master_config_path }}.bak"
      args:
        warn: no
      become: yes
      register: htpasswd_identity_provider_content
    - debug:
        msg: "identity provider content htpasswd_identity_provider_content.stdout"
    -
      name: Add htpasswd identity provider to master config
      blockinfile:
        marker: "# {mark} GENERATED BY SSO UNINSTALLER"
        path: "{{ rhsso_openshift_master_config_path }}"
        insertafter: "identityProviders"
        backup: yes
        block: "{{ htpasswd_identity_provider_content.stdout }}"
      register: sso_master_config_update
      become: yes
      when: '"GENERATED BY SSO UNINSTALLER" not in master_config_raw.stdout'

    -
      name: Restart master api
      become: yes
      shell: /usr/local/bin/master-restart api
    -
      name: Restart master controllers
      become: yes
      shell: /usr/local/bin/master-restart controllers